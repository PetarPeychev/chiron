//dummy data
pgnData = [
    [
    '[Event "Altibox Norway Chess"]',
    '[Site "Stavanger Konserthus"]',
    '[Date "2016.04.19"]',
    '[EventDate "2016.??.??"]',
    '[Round "1.2"]',
    '[White "Carlsen, Magnus"]',
    '[Black "Harikrishna, P."]',
    '[Result "1-0"]',
    '[ECO "E15"]',
    '[WhiteElo "2851"]',
    '[BlackElo "2763"]',
    '[PlyCount "81"]',
    '',
    '1. d4 Nf6 2. c4 e6 3. Nf3 b6 4. g3 Ba6 5. Nbd2 Bb4 6. Qa4 c5 7. a3 Bxd2+ 8.Bxd2 O-O 9. dxc5 bxc5 10. Bg2 Qb6 11. O-O Nc6 12. Be3 Rfc8 13. Rfd1 d5 14. cxd5 exd5 15. Bxc5 Qa5 16. Qc2 Bxe2 17. Qxe2 Qxc5 18. Rac1 Qb6 19. b4 h6 20. Qe3 Qb7 21. Bh3 Re8 22. Qc3 Ne7 23. Nd4 Ne4 24. Qc7 Qa6 25. f3 Ng5 26. Bd7 Red8 27. h4 Nxf3+ 28. Nxf3 Qxa3 29. Kg2 Qb2+ 30. Rd2 Qxb4 31. Re1 a5 32. Rde2 Ng6 33. h5 Nh8 34. Bf5 a4 35. Ne5 Qd6 36. Qc2 Re8 37. Bh7+ Kf8 38. Qf5 Re7 39. Bg6 Kg8 40. Nxf7 Rxf7 41. Bxf7+ 1-0'
     ],
      
    
    [
    '[Event "Altibox Norway Chess"]',
    '[Site "Stavanger Konserthus"]',
    '[Date "2016.04.20"]',
    '[EventDate "2016.??.??"]',
    '[Round "2.4"]',
    '[White "Topalov, Veselin"]',
    '[Black "Carlsen, Magnus"]',
    '[Result "1/2-1/2"]',
    '[ECO "D37"]',
    '[WhiteElo "2754"]',
    '[BlackElo "2851"]',
    '[PlyCount "58"]',
    '',
    '1. d4 Nf6 2. c4 e6 3. Nf3 d5 4. Nc3 Nbd7 5. Qc2 c6 6. cxd5 exd5 7. Bf4 Nh5 8.g3 Nxf4 9. gxf4 Nb6 10. e3 g6 11. h4 Bb4 12. Bd3 Bg4 13. Ne5 Bh5 14. Be2 Bxe2 15. Kxe2 f6 16. Nd3 Bxc3 17. Qxc3 Qe7 18. Qc5 Nc4 19. Qxe7+ Kxe7 20. h5 Rag8 21. hxg6 hxg6 22. a4 a5 23. b3 Nd6 24. Rag1 Kf7 25. Rc1 Rh5 26. Rhg1 Rh2 27.Rh1 Rh5 28. Rhg1 Rh2 29. Rh1 Rh5 1/2-1/2'
    ],
    [
    '[Event "Altibox Norway Chess"]',
    '[Site "Stavanger Konserthus"]',
    '[Date "2016.04.21"]',
    '[Round "3.3"]',
    '[White "Carlsen, Magnus"]',
    '[Black "Grandelius, Nils"]',
    '[Result "1-0"]',
    '[ECO "B29"]',
    '[WhiteElo "2851"]',
    '[BlackElo "2649"]',
    '[PlyCount "75"]',
    '[EventDate "2016.??.??"]',
    
    '1. e4 c5 2. Nf3 Nf6 3. e5 Nd5 4. Nc3 Nxc3 5. dxc3 Nc6 6. Bf4 Qb6 7. Qc1 f6 8. Bc4 g5 9. Bg3 g4 10. exf6 gxf3 11. Qf4 fxg2 12. Rg1 Na5 13. f7+ Kd8 14. Bd5 Bh6 15. Qe5 Rf8 16. Bh4 Rxf7 17. Bxf7 Nc6 18. Qg3 Qxb2 19. Rd1 Qxc2 20. Bd5 Qf5 21. Rxg2 Bf4 22. Qf3 Kc7 23. Rg5 Qf8 24. Bg3 e5 25. Rh5 a5 26. Rxh7 Ra6 27. Rf7 Qe8 28. Kf1 Bxg3 29. hxg3 Qh8 30. Kg2 Nd8 31. Rf8 Qg7 32. Rh1 Rh6 33. Rxh6 Qxh6 34. Qf6 Qxf6 35. Rxf6 d6 36. Kf3 b5 37. g4 Kd7 38. Rh6 1-0'
    ],
    [
    '[Event "Altibox Norway Chess"]',
    '[Site "Stavanger Konserthus"]',
    '[Date "2016.04.22"]',
    '[Round "4.2"]',
    '[White "Li, Chao"]',
    '[Black "Carlsen, Magnus"]',
    '[Result "1/2-1/2"]',
    '[ECO "D14"]',
    '[WhiteElo "2755"]',
    '[BlackElo "2851"]',
    '[PlyCount "73"]',
    '[EventDate "2016.??.??"]',
    
    '1. d4 d5 2. Nf3 Nf6 3. c4 c6 4. cxd5 cxd5 5. Nc3 Nc6 6. Bf4 Bf5 7. e3 e6 8. Bd3 Bxd3 9. Qxd3 Bd6 10. Bxd6 Qxd6 11. O-O O-O 12. Rac1 Rfc8 13. h3 h6 14. Nd2 Nd7 15. a3 Nb6 16. Qb5 Qd8 17. Na4 Nxa4 18. Qxa4 Qa5 19. Qd1 Ne7 20. Qe2 Qa4 21. Qd3 Nf5 22. Qb3 Qa6 23. Qb4 Nd6 24. a4 Qb6 25. Qa3 a5 26. Rc5 Qb4 27. Qxb4 axb4 28. Rfc1 Rxc5 29. dxc5 Rc8 30. Kf1 Nc4 31. Nxc4 Rxc5 32. b3 dxc4 33. bxc4 Ra5 34. Ra1 Rc5 35. Rc1 Ra5 36. Ra1 Rc5 37. Rc1 1/2-1/2'
    ],
    [
    '[Event "Altibox Norway Chess"]',
    '[Site "Stavanger Konserthus"]',
    '[Date "2016.04.24"]',
    '[Round "5.4"]',
    '[White "Carlsen, Magnus"]',
    '[Black "Giri, Anish"]',
    '[Result "1/2-1/2"]',
    '[ECO "C77"]',
    '[WhiteElo "2851"]',
    '[BlackElo "2790"]',
    '[PlyCount "95"]',
    '[EventDate "2016.??.??"]',
    '1. e4 e5 2. Nf3 Nc6 3. Bb5 a6 4. Ba4 Nf6 5. d3 b5 6. Bb3 Bc5 7. Nc3 d6 8. Nd5 h6 9. c3 O-O 10. O-O Rb8 11. Re1 Ba7 12. Be3 Bxe3 13. Rxe3 Na5 14. Bc2 c5 15.b4 cxb4 16. Nxb4 Qc7 17. Qd2 Nc6 18. Nxc6 Qxc6 19. h3 Be6 20. d4 Qc7 21. Bb3 Rfe8 22. Bxe6 Rxe6 23. a4 exd4 24. Qxd4 bxa4 25. Qxa4 Rbe8 26. Qxa6 Rxe4 27.Rxe4 Rxe4 28. Qd3 Re8 29. Nd4 d5 30. Nf5 Qf4 31. g3 Qe4 32. Rd1 Qxd3 33. Rxd3 Kf8 34. f3 Ra8 35. g4 Ra3 36. Kf2 h5 37. Ke3 g6 38. Nd4 hxg4 39. hxg4 Nd7 40.Nb5 Rb3 41. Rxd5 Nb6 42. Rc5 Na4 43. Rc8+ Kg7 44. Rc4 Nb6 45. Rc5 Na4 46. Rc4 Nb6 47. Rc5 Na4 48. Rc4 1/2-1/2'
    ],
    [
    '[Event "Altibox Norway Chess"]',
    '[Site "Stavanger Konserthus"]',
    '[Date "2016.04.25"]',
    '[Round "6.3"]',
    '[White "Vachier-Lagrave, Maxime"]',
    '[Black "Carlsen, Magnus"]',
    '[Result "1/2-1/2"]',
    '[ECO "C67"]',
    '[WhiteElo "2788"]',
    '[BlackElo "2851"]',
    '[PlyCount "129"]',
    '[EventDate "2016.??.??"]',
    
    '1. e4 e5 2. Nf3 Nc6 3. Bb5 Nf6 4. O-O Nxe4 5. d4 Nd6 6. Bxc6 dxc6 7. dxe5 Nf5 8. Qxd8+ Kxd8 9. h3 Ke8 10. Nc3 h5 11. Bf4 Be7 12. Rad1 Be6 13. Ng5 Rh6 14. Rfe1 Bb4 15. g4 hxg4 16. hxg4 Ne7 17. f3 Bxc3 18. bxc3 Bxa2 19. Ne4 Rh8 20. e6 Bxe6 21. Bxc7 Nd5 22. Be5 Kf8 23. Nc5 b5 24. c4 bxc4 25. Rd4 Re8 26. Rxc4 Rh6 27. Ra4 Kg8 28. Rxa7 Bc8 29. Bg3 Rxe1+ 30. Bxe1 Rd6 31. Ba5 Bxg4 32. fxg4 Rg6 33. Kf2 Rxg4 34. Bd2 Rc4 35. Ra8+ Kh7 36. Nd7 Rxc2 37. Ke2 f6 38. Kd3 Rb2 39. Nf8+ Kg8 40. Ne6+ Kh7 41. Ra7 Rb3+ 42. Kd4 Rg3 43. Kc5 Rg2 44. Ba5 Ne3 45. Kxc6 Nf5 46. Bb4 Re2 47. Kd7 Re4 48. Bc5 Kg6 49. Ra1 Re5 50. Bd6 Nxd6 51. Kxd6 Rb5 52. Rg1+ Kh6 53. Nf4 Kh7 54. Nd5 g5 55. Ke6 Kg7 56. Rf1 Ra5 57. Nxf6 Kg6 58. Nd5 Ra6+ 59. Ke5 Ra8 60. Ne7+ Kh5 61. Rh1+ Kg4 62. Rg1+ Kh5 63. Rh1+ Kg4 64. Rg1+ Kh5 65. Rh1+ 1/2-1/2'
    ],
    [
    '[Event "Altibox Norway Chess"]',
    '[Site "Stavanger Konserthus"]',
    '[Date "2016.04.29"]',
    '[Round "7.3"]',
    '[White "Carlsen, Magnus"]',
    '[Black "Kramnik, Vladimir"]',
    '[Result "1-0"]',
    '[ECO "D35"]',
    '[WhiteElo "2851"]',
    '[BlackElo "2801"]',
    '[PlyCount "99"]',
    '[EventDate "2016.??.??"]',
    
    '1. d4 d5 2. c4 e6 3. Nc3 Nf6 4. cxd5 exd5 5. Bg5 c6 6. e3 Bf5 7. Qf3 Bg6 8. Bxf6 Qxf6 9. Qxf6 gxf6 10. Nf3 Nd7 11. Nh4 Be7 12. Ne2 Nb6 13. Ng3 Bb4+ 14. Kd1 Na4 15. Ngf5 Kd7 16. Rb1 Ke6 17. Bd3 Rhc8 18. Ke2 Bf8 19. g4 c5 20. Ng2 cxd4 21. exd4 Bd6 22. h4 h5 23. Ng7+ Ke7 24. gxh5 Bxd3+ 25. Kxd3 Kd7 26. Ne3 Nb6 27. Ng4 Rh8 28. Rhe1 Be7 29. Nf5 Bd8 30. h6 Rc8 31. b3 Rc6 32. Nge3 Bc7 33. Rbc1 Rxc1 34. Rxc1 Bf4 35. Rc5 Ke6 36. Ng7+ Kd6 37. Ng4 Nd7 38. Rc2 f5 39. Nxf5+ Ke6 40. Ng7+ Kd6 41. Re2 Kc6 42. Re8 Rxe8 43. Nxe8 Nf8 44. Ne5+ Bxe5 45. dxe5 Kd7 46. Nf6+ Ke6 47. h5 Kxe5 48. Nd7+ Nxd7 49. h7 Nc5+ 50. Ke2 1-0'
    ],
    [
    '[Event "Altibox Norway Chess"]',
    '[Site "Stavanger Konserthus"]',
    '[Date "2016.04.29"]',
    '[Round "8.4"]',
    '[White "Aronian, Levon"]',
    '[Black "Carlsen, Magnus"]',
    '[Result "1-0"]',
    '[ECO "A15"]',
    '[WhiteElo "2784"]',
    '[BlackElo "2851"]',
    '[PlyCount "61"]',
    '[EventDate "2016.??.??"]',
    
    '1. c4 Nf6 2. g3 c6 3. Bg2 d5 4. Nf3 g6 5. b3 Bg7 6. Bb2 O-O 7. O-O dxc4 8. bxc4 c5 9. d3 Nc6 10. Ne5 Na5 11. Qc1 Qc7 12. Nd2 Ne8 13. f4 Nd6 14. Bc3 Rb8 15. Qa3 b6 16. Bxa5 bxa5 17. Nb3 Nb7 18. Bxb7 Qxb7 19. Nxc5 Qc7 20. d4 Rd8 21. Rfd1 f6 22. Nf3 e5 23. fxe5 fxe5 24. Nxe5 Bxe5 25. dxe5 Rxd1+ 26. Rxd1 Qxe5 27. Rd8+ Kf7 28. Qf3+ Bf5 29. Rxb8 Qxb8 30. g4 Qb4 31. Nd3 1-0'
    ],
    [
    '[Event "Altibox Norway Chess"]',
    '[Site "Stavanger Konserthus"]',
    '[Date "2016.04.29"]',
    '[Round "9.2"]',
    '[White "Carlsen, Magnus"]',
    '[Black "Eljanov, Pavel"]',
    '[Result "1-0"]',
    '[ECO "D30"]',
    '[WhiteElo "2851"]',
    '[BlackElo "2765"]',
    '[PlyCount "69"]',
    '[EventDate "2016.??.??"]',
    
    '1. d4 d5 2. c4 e6 3. Nf3 Nf6 4. g3 Bb4+ 5. Bd2 Be7 6. Bg2 O-O 7. O-O c6 8. Qc2 Nbd7 9. a4 a5 10. Rc1 Ne4 11. Be1 f5 12. Nbd2 Bd6 13. e3 Ra7 14. Qd1 b6 15. cxd5 cxd5 16. Nb1 Ba6 17. Na3 Qa8 18. Nb5 Bxb5 19. axb5 Rc8 20. Bf1 Rxc1 21. Rxc1 Rc7 22. Rxc7 Bxc7 23. Qa4 Qb8 24. b4 axb4 25. Bxb4 h6 26. Qc2 Bd6 27. Qc6 Ndf6 28. Bxd6 Qxd6 29. Qc8+ Kh7 30. Ne5 Qe7 31. Qc6 Ng4 32. Nxg4 fxg4 33. Bd3 g6 34. Bxe4 dxe4 35. Qxb6 1-0'
    ]
    ];
    
    //Write the game to the DOM
    function writeGameText(g) {
    
      //remove the header to get the moves
      var h = g.header();
      var gameHeaderText = '<h4>' + h.White + ' (' + h.WhiteElo + ') - ' + h.Black + ' (' + h.BlackElo + ')</h4>';
      gameHeaderText += '<h5>' + h.Event + ', ' + h.Site + ' ' + h.EventDate + '</h5>';
      var pgn = g.pgn();
      var gameMoves = pgn.replace(/\[(.*?)\]/gm, '').replace(h.Result, '').trim();
    
      //format the moves so each one is individually identified, so it can be highlighted
      moveArray = gameMoves.split(/([0-9]+\.\s)/).filter(function(n) {return n;});
      for (var i = 0, l = moveArray.length; i < l; ++i) {
        var s = $.trim(moveArray[i]);
        if (!/^[0-9]+\.$/.test(s)) { //move numbers
          m = s.split(/\s+/);
          for (var j = 0, ll = m.length; j < ll; ++j) {
            m[j] = '<span class="gameMove' + (i + j - 1) + '"><a id="myLink" href="#" onclick="goToMove(' + (i + j - 1) + ');return false;">' + m[j] + '</a></span>';
          }
          s = m.join(' ');
        }
        moveArray[i] = s;
      }
      $("#game-data").html(gameHeaderText + '<div class="gameMoves">' + moveArray.join(' ') + ' <span class="gameResult">' + h.Result + '</span></div>');
    
    }
    
    //buttons
    $('#btnStart').on('click', function() {
      game.reset();
      currentPly = -1;
      board.position(game.fen());
    });
    $('#btnPrevious').on('click', function() {
      if (currentPly >= 0) {
        game.undo();
        currentPly--;
        board.position(game.fen());
      }
    });
    $('#btnNext').on('click', function() {
      if (currentPly < gameHistory.length - 1) {
        currentPly++;
        game.move(gameHistory[currentPly].san);
        board.position(game.fen());
      }
    });
    $('#btnEnd').on('click', function() {
      while (currentPly < gameHistory.length - 1) {
        currentPly++;
        game.move(gameHistory[currentPly].san);
      }
      board.position(game.fen());
    });
    
    //key bindings
    $(document).ready(function(){
    
      $(document).keydown(function(e){
        if (e.keyCode == 39) { //right arrow
          if (e.ctrlKey) {
            $('#btnEnd').click();
          } else {
            $('#btnNext').click();
          }
          return false;
        }
      });
    
      $(document).keydown(function(e){
        if (e.keyCode == 37) { //left arrow
          if (e.ctrlKey) {
            $('#btnStart').click();
          } else {
            $('#btnPrevious').click();
          }
        }
        return false;
      });
    
      $(document).keydown(function(e){
        if (e.keyCode == 38) { //up arrow
          if (currentGame > 0) {
            if (e.ctrlKey) {
              loadGame(0);
            } else {
              loadGame(currentGame - 1);
            }
          }
          $('#gameSelect').val(currentGame);
        }
        return false;
      });
    
      $(document).keydown(function(e){
        if (e.keyCode == 40) { //down arrow
          if (currentGame < pgnData.length - 1) {
            if (e.ctrlKey) {
              loadGame(pgnData.length - 1);
            } else {
              loadGame(currentGame + 1);
            }
          }
          $('#gameSelect').val(currentGame);
        }
        return false;
      });
    
    
    });
    
    //used for clickable moves in gametext
    //not used for buttons for efficiency
    function goToMove(ply) {
      if (ply > gameHistory.length - 1) ply = gameHistory.length - 1;
      game.reset();
      for (var i = 0; i <= ply; i++) {
        game.move(gameHistory[i].san);
      }
      currentPly = i - 1;
      board.position(game.fen());
    }
    
    var onChange = function onChange() { //fires when the board position changes
      //highlight the current move
      $("[class^='gameMove']").removeClass('highlight');
      $('.gameMove' + currentPly).addClass('highlight');
    }
    
    function loadGame(i) {
      game = new Chess();
      game.load_pgn(pgnData[i].join('\n'), {newline_char:'\n'});
      writeGameText(game);
      gameHistory = game.history({verbose: true});
      goToMove(-1);
      currentGame = i;
    }
    
    //start doing stuff
    var board, //the chessboard
        game, //the current  game
        games, //array of all loaded games
        gameHistory,
        currentPly,
        currentGame;
    
    //only need the headers here, issue raised on github
    //read all the games to populate the select
    
    for (var i = 0; i < pgnData.length; i++) {
      var g = new Chess();
      g.load_pgn(pgnData[i].join('\n'), {newline_char:'\n'});
      var h = g.header();
      var opp;
      if (h.White == "Carlsen, Magnus"){
          opp = "White vs " + h.Black;
      } else {
          opp = "Black vs " + h.White;
      }
      $('#gameSelect')
         .append($('<option></option>')
         .attr('value', i)
         .text(opp + ', ' + h.Event + ' ' + h.Site + ' ' + h.Date));
    }
    
    //set up the board
    var cfg = {
      position: 'start',
      showNotation: false,
      onChange: onChange
    };
    board = new ChessBoard('board', cfg);
    $(window).resize(board.resize);
    
    //load the first game
    loadGame(0);